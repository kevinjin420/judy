<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Avatar Framework</title>
    <style>
        html, body {
            margin: 0;
            padding: 0;
            height: 100vh;
            width: 100vw;
            overflow: hidden;
            font-family: var(--vscode-font-family);
            font-size: var(--vscode-font-size);
            color: var(--vscode-foreground);
            background-color: var(--vscode-editor-background);
        }

        .container {
            display: flex;
            flex-direction: column;
            height: 100vh;
            width: 100%;
            box-sizing: border-box;
            padding: 12px;
            gap: 12px;
        }

        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 8px 0;
            border-bottom: 1px solid var(--vscode-panel-border);
            flex-shrink: 0;
        }

        .character-selector {
            background: var(--vscode-dropdown-background);
            border: 1px solid var(--vscode-dropdown-border);
            color: var(--vscode-dropdown-foreground);
            padding: 4px 8px;
            border-radius: 4px;
            font-family: inherit;
            font-size: 11px;
            cursor: pointer;
        }

        .state-selector {
            background: var(--vscode-dropdown-background);
            border: 1px solid var(--vscode-dropdown-border);
            color: var(--vscode-dropdown-foreground);
            padding: 4px 8px;
            border-radius: 4px;
            font-family: inherit;
            font-size: 11px;
            cursor: pointer;
        }

        .avatar-display {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            flex: 1;
            min-height: 0;
        }

        .avatar-image {
            width: 100%;
            height: 100%;
            max-width: 100%;
            max-height: 100%;
            flex-shrink: 0;
            object-fit: contain;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <select class="character-selector" id="characterSelector">
                <option value="">Loading characters...</option>
            </select>
            <select class="state-selector" id="stateSelector">
                <option value="idle">Idle</option>
                <option value="talking">Talking</option>
            </select>
        </div>

        <div class="avatar-display">
            <img class="avatar-image" id="avatarImage" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVR42mNkYPhfDwAChAGAWGZPFwAAAABJRU5ErkJggg==" alt="Avatar" />
        </div>
    </div>

    <script>
        const vscode = acquireVsCodeApi();

        // Get saved state
        const state = vscode.getState() || { selectedCharacter: null, currentState: 'idle' };

        // DOM elements
        const characterSelector = document.getElementById('characterSelector');
        const avatarImage = document.getElementById('avatarImage');
        const stateSelector = document.getElementById('stateSelector');

        // Current frame map
        let currentFrameMap = null;

        // Initialize
        function initialize() {
            vscode.postMessage({ type: 'getCharacters' });

            if (state.selectedCharacter) {
                vscode.postMessage({
                    type: 'selectCharacter',
                    characterId: state.selectedCharacter
                });
            }
        }

        // Update character display
        function updateCharacterDisplay(character) {
            if (!character) return;

            // Save state
            state.selectedCharacter = character.id;
            vscode.setState(state);

            // Request frame map for this character
            vscode.postMessage({ type: 'getFrameMap', characterId: character.id });
        }

        // Update avatar state
        function updateAvatarState(newState, frameMap) {
            // Update dropdown selection
            stateSelector.value = newState;

            // Load the frame for this state
            if (frameMap && frameMap[newState] && state.selectedCharacter) {
                const frameName = frameMap[newState];
                vscode.postMessage({
                    type: 'getFrameImage',
                    characterId: state.selectedCharacter,
                    frameName: frameName
                });
            }

            state.currentState = newState;
            vscode.setState(state);
        }

        // Event listeners
        characterSelector.addEventListener('change', (e) => {
            if (e.target.value) {
                vscode.postMessage({
                    type: 'selectCharacter',
                    characterId: e.target.value
                });
            }
        });

        stateSelector.addEventListener('change', (e) => {
            if (e.target.value) {
                vscode.postMessage({ type: 'setState', state: e.target.value });
            }
        });

        // Handle messages from extension
        window.addEventListener('message', event => {
            const message = event.data;

            switch (message.type) {
                case 'charactersLoaded':
                    characterSelector.innerHTML = '';
                    message.characters.forEach(char => {
                        const option = document.createElement('option');
                        option.value = char.id;
                        option.textContent = char.displayName;
                        characterSelector.appendChild(option);
                    });

                    if (state.selectedCharacter) {
                        characterSelector.value = state.selectedCharacter;
                    } else if (message.characters.length > 0) {
                        characterSelector.value = message.characters[0].id;
                        vscode.postMessage({
                            type: 'selectCharacter',
                            characterId: message.characters[0].id
                        });
                    }
                    break;

                case 'characterSelected':
                    updateCharacterDisplay(message.character);
                    currentFrameMap = message.frameMap;
                    updateAvatarState('idle', currentFrameMap);
                    break;

                case 'stateChanged':
                    updateAvatarState(message.state, message.frameMap);
                    break;

                case 'frameMap':
                    // Store frame map for current character
                    if (state.selectedCharacter === message.characterId) {
                        currentFrameMap = message.frameMap;
                        updateAvatarState(state.currentState, currentFrameMap);
                    }
                    break;

                case 'frameImage':
                    // Update avatar image with new frame
                    avatarImage.src = message.imageUrl;
                    break;

                case 'error':
                    updateAvatarState('error');
                    break;
            }
        });

        // Initialize the interface
        initialize();
    </script>
</body>
</html>